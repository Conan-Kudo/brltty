###############################################################################
# libbrlapi - A library providing access to braille terminals for applications.
#
# Copyright (C) 2005-2018 by
#   Alexis Robert <alexissoft@free.fr>
#   Samuel Thibault <Samuel.Thibault@ens-lyon.org>
#
# libbrlapi comes with ABSOLUTELY NO WARRANTY.
#
# This is free software, placed under the terms of the
# GNU Lesser General Public License, as published by the Free Software
# Foundation; either version 2.1 of the License, or (at your option) any
# later version. Please see the file LICENSE-LGPL for details.
#
# Web Page: http://brltty.app/
#
# This software is maintained by Dave Mielke <dave@mielke.cc>.
###############################################################################

include $(SRC_TOP)bindings.mk

PYTHON3_OK = @PYTHON3_OK@
PYTHON3 = @PYTHON3@
PYTHON3_PROLOGUE = @PYTHON3_PROLOGUE@
PYTHON3_VERSION = @PYTHON3_VERSION@
PYTHON3_CPPFLAGS = @PYTHON3_CPPFLAGS@
PYTHON3_LIBS = @PYTHON3_LIBS@
PYTHON3_EXTRA_LIBS = @PYTHON3_EXTRA_LIBS@
PYTHON3_EXTRA_LDFLAGS = @PYTHON3_EXTRA_LDFLAGS@
PYTHON3_SITE_PKG = @PYTHON3_SITE_PKG@

CYTHON = @CYTHON@
CYTHON_CFLAGS = @CYTHON_CFLAGS@

PYTHON3_DESTDIR = $(INSTALL_ROOT)
PYTHON3_PREFIX =

PYTHON3_MODULE = $(API_NAME)
PYTHON3_API = $(PYTHON3_MODULE).$(LIB_EXT)

all: $(PYTHON3_API)

$(PYTHON3_API): brlapi.auto.c $(API_HDRS) brlapi
	set -- --quiet build --build-temp .; \
	[ "@host_os@" != "mingw32" ] || set -- "$${@}" --compiler mingw32; \
	$(PYTHON3) ./setup.py "$${@}"
	[ "@host_os@" != "mingw32" ] || $(PYTHON3) ./setup.py --quiet bdist_wininst --skip-build

brlapi.auto.c: $(SRC_DIR)/brlapi.pyx $(SRC_DIR)/c_brlapi.pxd constants.auto.pyx
	$(CYTHON) -I. -o $@ $(SRC_DIR)/brlapi.pyx

constants.auto.pyx: $(CONSTANTS_DEPENDENCIES)
	$(AWK) $(CONSTANTS_ARGUMENTS) >$@

doc: $(PYTHON3_API)
	LD_PRELOAD=$(API_LIB) $(PYTHON3) $(SRC_DIR)/mkdoc.py $(PYTHON3_MODULE)

INSTALLED_FILES = installed-files

install: all
	set -- --quiet install --skip-build --record "$(INSTALLED_FILES)"; \
	[ -z "$(PYTHON3_DESTDIR)" ] || set -- "$${@}" --root "$(PYTHON3_DESTDIR)"; \
	[ -z "$(PYTHON3_PREFIX)" ] || set -- "$${@}" --prefix "$(PYTHON3_PREFIX)"; \
	$(PYTHON3) ./setup.py "$${@}"

uninstall:
	[ ! -f "$(INSTALLED_FILES)" ] || rm -f -- `$(AWK) '{printf "%s%s ", "$(PYTHON3_DESTDIR)", $$0}' "$(INSTALLED_FILES)"`

clean::
	-rm -f -- $(PYTHON3_API) *.auto.* *.html "$(INSTALLED_FILES)"
	-rm -f -r -- build
	-rm -f -r -- dist
	-rm -f -r -- Release

distclean::
	-rm -f -- setup.py
